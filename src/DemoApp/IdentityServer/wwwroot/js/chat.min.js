"use strict";function connect(n){$("#connState").text("正在连接……");n.start().then(function(){$("#connState").text("已连接");console.log("连接成功")}).catch(function(n){$("#connState").text("连接失败，请检查网络状况");console.log(n)})}function chatContentResize(n){n.css("display","inline");n.parent().css("width","auto");$(".chat-board").width()*.75>n.width()&&n.parent().width(n.width()+15);n.css("display","block")}function isAtBottom(n){var t=n[0],i=t.scrollTop,r=t.scrollHeight,u=t.clientHeight;return i+u>=r?!0:!1}function scrollToBottom(n){var t=n[0],i=t.scrollTop,r=t.clientHeight;n.animate({scrollTop:i+r},500)}$(document).ready(function(){function t(t){var i=document.getElementById("messageInput").value;/^\s*$/.test(i)||(n.invoke("SendMessage",i).then(function(){$("#messageInput").val("")}).catch(function(n){return console.log(n.toString())}),t.preventDefault())}var n=(new window.signalR.HubConnectionBuilder).withUrl("/chatHub").withAutomaticReconnect({nextRetryDelayInMilliseconds:n=>{if(n.previousRetryCount<=3){var t=5;return n.previousRetryCount===0?$("#connState").text("连接中断，将在"+t+"秒后重连……"):$("#connState").text("第"+n.previousRetryCount+"次重新连接失败，将在"+t+"秒后重试……"),console.error(n.retryReason),t*1e3}return $("#connState").text("已"+n.previousRetryCount+"次重新连接失败，请检查网络状况。点击上线按钮重新连接"),console.error(n.retryReason),null}}).configureLogging(window.signalR.LogLevel.Information).build();n.on("ReceiveMessage",function(n,t){var i,r,u;i=n===$("#user").val()?$("#messageBubbleTemplate .chat-self").eq(0).clone():$("#messageBubbleTemplate .chat-other").eq(0).clone();$(".name",i).text(n);$(".logo img",i).attr("src","/images/userLogo/"+n+".png");$(".content",i).text(t);r=$(".chat-board");u=isAtBottom(r);r.append(i);chatContentResize($(".content",i));u&&scrollToBottom(r)});n.on("ReceiveOnlineNotice",function(n){var i=$("#messageBubbleTemplate .chat-notice").eq(0).clone(),t,r;$("span",i).text("用户 "+n+" 上线");t=$(".chat-board");r=isAtBottom(t);t.append(i);chatContentResize($(".content",i));r&&scrollToBottom(t)});n.on("ReceiveOfflineNotice",function(n){var i=$("#messageBubbleTemplate .chat-notice").eq(0).clone(),t,r;$("span",i).text("用户 "+n+" 下线");t=$(".chat-board");r=isAtBottom(t);t.append(i);chatContentResize($(".content",i));r&&scrollToBottom(t)});n.on("ReceiveClearChatBoardCommand",function(n){var t,i,r;$(".chat-board").empty();t=$("#messageBubbleTemplate .chat-notice").eq(0).clone();$("span",t).text("用户 "+n+" 清空了所有人的聊天版");i=$(".chat-board");r=isAtBottom(i);i.append(t);chatContentResize($(".content",t));r&&scrollToBottom(i)});connect(n);n.onreconnecting(()=>{$("#connState").text("正在重新连接……")});n.onreconnected(()=>{$("#connState").text("已连接")});n.onclose(function(n){$("#connState").text("连接已关闭");console.log("连接已关闭");n&&console.log(n)});document.getElementById("send").addEventListener("click",t);$("#offline").click(function(){n.connection.connectionState!==window.signalR.HubConnectionState.Disconnected&&n.stop()});$("#online").click(function(){n.connection.connectionState===window.signalR.HubConnectionState.Disconnected&&connect(n)});$("#clearChatBoard").click(function(){$.ajax({url:"/SignalR/Chat/Index?handler=ClearOnlineUsersChatBoard",error:function(){alert("清空失败")}})});$(document).keypress(function(n){n.ctrlKey&&n.keyCode===10&&t(n)});$(window).resize(function(){elementResize(".chat-board")});$(".chat-board").resize(function(){var n=$(".chat-self .content, .chat-other .content");n.each(function(){chatContentResize($(this))})});elementResize(".chat-board")});